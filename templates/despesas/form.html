{% extends 'base.html' %}

{% block title %}Cadastro de Despesas{% endblock %}

{% block content %}
<div class="content-box">
    <h2>Cadastro de Despesas do Veículo {{ placaAtual }}</h2>
    <form action="{{ url_for('bpDespesa.salvar') }}" method="post">
        <input type="hidden" name="iddespesa" value="{{ d.iddespesa }}">

        <div class="form-group">
            <label for="descricao">Descrição</label>
            <input type="text" id="descricao" name="descricao" value="{{ d.descricao }}" required>
        </div>
        <div class="form-group">
            <label for="valor">Valor</label>
            <input type="text" id="valor" name="valor" value="{{ d.valor }}" required>
        </div>
        <div class="form-group">
            <label for="data">Data</label>
            <input type="date" id="data" name="data" value="{{ d.data_servico }}">
        </div>

        <div class="form-group">
            <label for="pesquisaPrestadorInput">Pesquisar Prestador</label>
            <input type="text" id="pesquisaPrestadorInput" placeholder="Digite para filtrar..." class="form-control">
        </div>
        <div class="form-group">
            <label for="idprestador">Prestador de Serviço</label>
            <select id="idprestador" name="idprestador" required>
                <option value="">Selecione um prestador...</option>
                {% for prestador in prestadores %}
                    <option value="{{ prestador.idprestador }}"
                            {% if d.prestador and d.prestador.idprestador == prestador.idprestador %}selected{% endif %}>
                        {{ prestador.nome_empresa }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-actions">
            <button type="submit" class="button save-button">Salvar</button>
            <a href="{{ url_for('bpDespesa.lista', idveiculo=placaAtual) }}" class="button cancel-button">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Executa o script quando o conteúdo da página estiver totalmente carregado
    document.addEventListener('DOMContentLoaded', function() {

        // Pega os elementos do DOM
        const pesquisaInput = document.getElementById('pesquisaPrestadorInput');
        const prestadorSelect = document.getElementById('idprestador');
        const todasAsOpcoes = Array.from(prestadorSelect.options); // Converte as opções em um array

        // Adiciona um "ouvinte" que reage a cada tecla digitada no campo de pesquisa
        pesquisaInput.addEventListener('keyup', function() {
            const termoPesquisado = pesquisaInput.value.toLowerCase();

            // Guarda a opção atualmente selecionada, se houver
            const valorSelecionado = prestadorSelect.value;

            // Limpa o select para adicionar apenas as opções filtradas
            prestadorSelect.innerHTML = '';

            // Filtra o array de opções e adiciona de volta ao select
            todasAsOpcoes.forEach(function(opcao) {
                const textoOpcao = opcao.text.toLowerCase();

                // Se o texto da opção incluir o termo pesquisado, ou se for a primeira opção ("Selecione..."),
                // ela será exibida.
                if (textoOpcao.includes(termoPesquisado) || opcao.value === '') {
                    // Adiciona a opção de volta ao select. O `cloneNode(true)` é importante
                    // para não mover o nó original, mas sim uma cópia.
                    prestadorSelect.add(opcao.cloneNode(true));
                }
            });

            // Tenta restaurar a seleção anterior se a opção ainda existir na lista filtrada
            prestadorSelect.value = valorSelecionado;
        });
    });
</script>
{% endblock %}